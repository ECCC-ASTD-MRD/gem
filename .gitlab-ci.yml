variables:
  ORD_SOUMET_SHELL: "/bin/bash"
  ORD_SOUMET_CPUS: "40"
  ORD_SOUMET_TMPFS: "8G"
  ORD_SOUMET_M: "80G"
  ORD_SOUMET_W: "10"
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build

before_script:
    - export CLICOLOR_FORCE=1

build_intel_dorpnsi:
  stage: build
  only:
  - dev-submodules
  when: always
  script:
    - . ./.eccc_setup_intel
    - . ./.eccc_initial_setup
    - make cmake-with-system-rpn
    - make -j `nproc`
    - make -j `nproc` work

build_xc50:
  stage: build
  tags:
  - XC50-login
  only:
  - dev-submodules
  when: always
  script:
    - set +e
    - . ./.eccc_setup_intel
    - . ./.eccc_initial_setup
    - make cmake
    - make -j `nproc`
    - make -j `nproc` work

build_U2:
  stage: build
  tags:
  - U2
  only:
  - dev-submodules
  when: always
  script:
    - set +e
    - echo ordenv_dist = ${ORDENV_DIST}
    - echo ec_arch = ${EC_ARCH}
    - echo arch = ${ARCH}
    - echo ordenv_plat = ${ORDENV_PLAT}
    - echo base_arch = ${BASE_ARCH}
    - export COMPILER_SUITE=intel
    - . ./ci-env/latest/rhel-8-icelake-64/inteloneapi-2022.1.2.sh
    - . r.load.dot rpn/libs/19.7.0
    - . r.load.dot rpn/vgrid/20220216
    - . r.load.dot /home/cpi001/data/ords/packages-ssm
    - . ./.common_setup ${COMPILER_SUITE}
    - . ./.eccc_initial_setup
    - make cmake
    - make -j `nproc`
    - make -j `nproc` work

build_intel:
  stage: build
  only:
  - dev-submodules
  when: always
  script:
    - ln -sf /home/cpi001/gem_dbase .
    - . ./.eccc_setup_intel
    - . ./.eccc_initial_setup
    - . ssmuse-sh -x main/opt/cmake/cmake-3.16.4
    - make cmake
    - make -j `nproc`
    - make -j `nproc` work
  artifacts:
    expire_in: 2 hrs
    paths:
    - work-ubuntu-18.04-skylake-64-intel-19.0.3.199
    - gem_dbase

build_gnu:
  stage: build
  only:
  - dev-submodules
  when: always
  script:
    - set +e
    - ln -sf /home/cpi001/gem_dbase .
    - . ./.eccc_setup_gnu
    - . ./.eccc_initial_setup
    - make cmake
    - make -j `nproc`
    - make -j `nproc` work
  artifacts:
    expire_in: 2 hrs
    paths:
    - work-ubuntu-18.04-amd64-64-gnu-7.4.0
    - gem_dbase
