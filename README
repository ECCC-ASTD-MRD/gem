# How to get, compile and run GEM on a stick at the CMC.
Warning: dev-cmake_rpn branch uses a submodule. Make sure you follow the
instructions below for that branch

# getting gem-devel git repository
git clone git@gitlab.science.gc.ca:cpi001/gem-devel.git
cd gem-devel
git checkout dev-cmake_rpn
git submodule update --init --recursive

# preparing gem-devel compilation
./scripts/link-dbase.sh

. ./.eccc_setup_intel

# You cannot compile with Intel and then with GNU in the same shell
# unless you compile first with GNU
# To compile with GNU, you must load the code-tools first:
. r.load.dot rpn/code-tools/1.5.1
. ./.eccc_setup_gnu

Before the first build:
. ./.eccc_initial_setup

# building and installing GEM
make cmake
make build
make work

# running GEM: example
cd $GEM_WORK
runprep.sh -dircfg ./configurations/GEM_cfgs_LU_FISL_H
runmod.sh -dircfg ./configurations/GEM_cfgs_LU_FISL_H

# structure of the working environment
The following environment variables are created (examples):
- GEM_DIR=/users/dor/armn/cpi/local/gem-devel_ubuntu-18.04-amd64-64-intel-19.0.3.199
- GEM_GIT_DIR=/users/dor/armn/cpi/ords/gem/gem-devel
- GEM_WORK=work-ubuntu-18.04-amd64-64-intel-19.0.3.199
- GEM_ARCH=ubuntu-18.04-amd64-64-intel-19.0.3.199
- COMPILER_SUITE=intel
- COMPILER_VERSION=19.0.3.199

The structure of the build and work directories is different whether the $storage_model environment variable exists:

- Example if $storage_model exists:
  - GEM_DIR=/users/dor/armn/cpi/local/gem-devel_ubuntu-18.04-amd64-64-intel-19.0.3.199
  - in GEM_GIT_DIR:
    . build-ubuntu-18.04-amd64-64-intel-19.0.3.199 -> /local/drive1/armn/armncpi/storage/goas/gem-devel_ubuntu-18.04-amd64-64-intel-19.0.3.199/build
    . work-ubuntu-18.04-amd64-64-intel-19.0.3.199 -> /local/drive1/armn/armncpi/storage/goas/gem-devel_ubuntu-18.04-amd64-64-intel-19.0.3.199/work

- Example if $storage_model doesn't exist:
  - GEM_DIR=/users/dor/armn/cpi/ords/gem/gem-devel
  - build-ubuntu-18.04-amd64-64-intel-19.0.3.199
  - work-ubuntu-18.04-amd64-64-intel-19.0.3.199

# Using Visual Studio Code

See instructions on the Visual Studio Code Wiki page: https://wiki.cmc.ec.gc.ca/wiki/Visual_Studio_Code
to load the appropriate SSM domains.  It can then be launched by executing the vstudio script.
You can open a terminal within VSCode and go to the working directory to run GEM.
